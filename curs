#!/bin/sh

# Build script for CURSYS
# POSIX compatible shell script

set -e  # Exit on any error

echo "  Building CURSYS...  " | sed 's/.*/\x1b[44;97m&\x1b[0m/'

# Build web library
echo "Building web library..."
npx tsup src-lib/lib-web.ts --format esm --outDir _dist/lib-web --target es2020 --dts

# Build node library
echo "Building node library..."
npx tsup src-lib/lib-node.ts --format cjs --outDir _dist/lib-node --target node18 --dts

# Build node server
echo "Building node server..."
npx tsup src/node/serve.ts --format cjs --outDir _dist/node --target node18 --dts

# Copy assets to web directory
echo "Copying assets..."
if [ -d "src-assets" ]; then
    cp -r src-assets/* src/web/ 2>/dev/null || true
else
    echo "src-assets directory not found, skipping asset copy"
fi

# Build web client
echo "Building web client..."
npx tsup src/web/main.ts --format esm --outDir _dist/web --target es2020 --dts
cp src/web/index.html _dist/web/

echo "Build complete!"
echo "Starting server..."
node _dist/node/serve.js 